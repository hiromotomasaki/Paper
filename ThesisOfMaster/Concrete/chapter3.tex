%卒業論文用雛形
\documentclass[a4j,12pt,oneside,openany]{jsbook}
% 英語なら以下を使う．
%\documentclass[a4j,12pt,oneside,openany,english]{jsbook}

\include{begin}
\chapter{システム制御}
\label{ch:3}
 \section{緒言}
 \label{sec:3_1}
 \par
 本章では，タクシーが営業を行う領域をいくつかの部分領域（以下セルと呼ぶ）に分割し，セル間でのタクシーの移動モデルを混合論理動的システムでモデル化する．
そして，そのモデルを用いたモデル予測制御法を提案しアプリケーションへの実装結果を示す．
 \section{タクシー移動モデル}
 \label{sec:3_2}
 \par
 対象領域を$N$個のセルに分割する．
 時刻$k$のときのセル$i$（$i = 1, 2, \ldots, N$）での空車数を$x_i(k)$とおき，対象領域内のタクシーの実車数を$r(k)$とおく．
 時刻$k$でのセル$i$で空車が実車に変化するタクシー数を$s_i(k)$とおく．
 すなわち，時間区間$[k,\ k+1)$の間に，セル$i$で空車から実車になるタクシー数が$s_i(k)$である．
 時刻$k$でのセル$i$で実車が空車に変化するタクシー数を$e_i(k)$とおく．
さらに入力として，時刻$k$でのセル$i$からセル$j$へ移動する空車数を$u_{i, j}(k)$とおく．
つまり，$x_i(k)$と$r(k)$が時刻$k$におけるシステムの状態量を表し，$s_i(k)$と$e_i(k)$と$u_{i, j}(k)$が時刻$k+1$の状態量を記述するための変動量を表している．このとき，各セルの空車数のダイナミクスは
\begin{align}
 x_i(k+1) = x_i(k)-s_i(k)+e_i(k)+\sum_{j=1}^{N}\bigg(u_{j,i}(k)-u_{i,j}(k) \bigg) \label{eq:x}
\end{align}
となる．また，実車数のダイナミクスは
\begin{align}
 r(k+1) = r(k)+\sum_{i=1}^{N}\bigg(s_i(k)-e_i(k)\bigg) \label{eq:r}
\end{align}
となる．

ここで，式(\ref{eq:x})，(\ref{eq:r})から
\begin{align*}
 &r(k+1)+\sum_{i=1}^{N}x_i(k+1)\nonumber \\
 =\ & \Bigg(r(k)+\sum_{i=1}^{N}\bigg(s_i(k)-e_i(k)\bigg)\Bigg) + \sum_{i=1}^{N}\Bigg(x_i(k)-s_i(k)+e_i(k)+\sum_{j=1}^{N}\bigg(u_{j,i}(k)-u_{i,j}(k) \bigg)\Bigg)\\
 =\ & r(k)+\sum_{i=1}^{N}x_i(k)+\sum_{i=1}^{N}\sum_{j=1}^{N}\bigg(u_{j,i}(k)-u_{i,j}(k) \bigg)\\
 =\ & r(k)+\sum_{i=1}^{N}x_i(k)+\sum_{i=1}^{N}\sum_{j=1}^{N}\bigg(u_{i,j}(k)-u_{i,j}(k) \bigg)\\
 =\ & r(k)+\sum_{i=1}^{N}x_i(k)
\end{align*}
が示せる．
すなわち，タクシーの総数は変化しない．
タクシーの総数を$L$とおくと
\begin{align}
 r(k)= L-\sum_{i=1}^{N}x_i(k) \label{eq:r_new}
\end{align}
の関係が成り立つ．

\par
実車に変化するタクシー数$s_i(k)$については以下のように考える．
まず，時刻$k$での制御入力に従って移動してから実車になりうるとする．
このとき，時間区間$[k,\ k+1)$の間で実車から空車になるタクシーもすぐに実車になりうるので，時間区間$[k,\ k+1)$の間にセル$i$にいる実車になりうるタクシーの台数は$e_i(k)+\sum_{i=1}^{N}u_{j,i}(k)$であり，実車になる台数はこの数を超えることはないので，
\begin{align}
 h_i(k)=e_i(k) +\sum_{j=1}^{N}u_{j,i}(k) -\alpha_i d_i(k) \label{eq:h}
\end{align}
とおくと，
\begin{align}
 s_i(k)=\left\{
\begin{array}{ll}
 \alpha_i d_i(k) & \mbox{if }h_i(k) \geq 0 \\
h_i(k)+\alpha_i d_i(k) & \mbox{otherwise}
\end{array}\right. \label{eq:s}
\end{align}
と表される．
ただし，$\alpha_i$はセル$i$においてタクシーに乗車できる乗客の割合である．
つまり，領域内に乗客と空車のタクシーがいる状況でも，乗客を見つけることが出来ず，実車に変化できない場合を考慮したモデルになっている．
この定数$\alpha_i$は過去のデータから推定することができる．
$d_i(k)$は時間区間$[k,\ k+1)$の間にセル$i$で乗車できなかった客数であり，
\begin{align}
 d_i(k+1)=d_i(k)-s_i(k)+p_i(k) \label{eq:d}
\end{align}
と表される．
ただし，$p_i(k)$は時間区間$[k,\ k+1)$の間で発生する新たな乗客数で，過去の乗車データから予測される．

\par
空車に変化するタクシー数$e_i(k)$は
\begin{align}
 e_i(k)=\beta_{i}r(k) \label{eq:e}
\end{align}
とする．
ただし，$\beta_i$は実車全体の中でセル$i$で空車になる割合である．
この定数$\beta_i$は過去のデータから推定することができる．

\par
ここで，入力に関する制約として，各セル$i$について
\begin{align}
 x_i(k)=\sum_{j=1}^{N}u_{i,j}(k) \label{eq:input}
\end{align}
を与える．
このことは，各セルにおいて時刻$k$での空車をどこに移動させるかを決定し，それに沿って，空車が移動すると仮定していることになる．
空車は制御入力に従って移動してから実車に変化できると仮定する．
このように移動する空車数を定めると，式(\ref{eq:x})，(\ref{eq:input})から，各空車数のダイナミクスは
\begin{align}
 x_i(k+1) = e_i(k)-s_i(k)+\sum_{j=1}^{N} u_{j,i}(k) \label{eq:x_new}
\end{align}
となる．
さらに，自動車の移動速度の制約から必ず0になる$u_{i, j}(k)$がある．
例えば，時間単位で隣接するセルにしか移動できない場合には，セル$i$に隣接しないセル$\ell$については
\begin{align}
 u_{i, \ell}(k)=0 \qquad  \forall k \label{eq:ell}
\end{align}
とおく．

\par
以上より，タクシー移動モデルは以下のようになる．
\begin{align}
 x_i(k+1) &= e_i(k)-s_i(k)+\sum_{j=1}^{N} u_{j,i}(k) \label{eq:x1}\\
 r(k) &= L-\sum_{i=1}^{N}x_i(k) \label{eq:r1}\\
 e_i(k) &= \beta_{i}r(k) \label{eq:e1}\\
 s_i(k) &= \left\{
\begin{array}{ll}
 \alpha_i d_i(k) & \mbox{if }h_i(k) \geq 0 \\
h_i(k)+\alpha_i d_i(k) & \mbox{otherwise}
\end{array}\right. \label{eq:s1}\\
 d_i(k+1) &= d_i(k)-s_i(k)+p_i(k) \label{eq:d1}\\
 h_i(k) &= e_i(k) +\sum_{j=1}^{N}u_{j,i}(k) -\alpha_i d_i(k) \label{eq:h1}\\
 x_i(k) &= \sum_{j=1}^{N}u_{i,j}(k) \label{eq:input1}\\
 u_{i, \ell}(k) &= 0 \qquad  \mbox{if セル$i$からセル$j$に移動不可能}\label{eq:ell1}
\end{align}
ここで，式(\ref{eq:s1})が条件付きの式になっている．この式は以下のように変形すれは，システム全体は混合論理動的システムになる\cite{bib10, bib11}．

まず，以下の論理変数$\delta_i(k)\in\{ 0,\ 1\}$を導入する．
\begin{align}
 \delta_i(k)=
\left\{ \begin{array}{ll}
1 & \mbox{if }h_i(k)\geq 0 \\
0 & \mbox{otherwise}
\end{array} \right. \label{eq:delta}
\end{align}
と定義する．
このとき，制約条件式(\ref{eq:delta})は次の不等式制約条件になる\cite{bib10}．
\begin{align}
 h^{\inf}_{i}(k)(1-\delta_i(k))\leq h_i(k) \leq h^{\sup}_{i}(k) \delta_i(k)+(\delta_i(k) -1) \epsilon_i(k) \label{eq:delta_new}
\end{align}
ただし，$h^{\inf}_{i}(k)$，$h^{\sup}_{i}(k)\in\mathbb{R}$は$h_i(k)$の引数が取りうる任意の値に対して$h^{\inf}_{i}(k)\leq h_i(k)\leq h^{\sup}_{i}(k)$であり，$\epsilon_i(k)\in\mathbb{R}_{++}$は十分に小さな正の実数である．
実際に，式(\ref{eq:delta_new})は$\delta_i(k)=1$のときは
\begin{align*}
 0\leq h_i(k) \leq h^{\sup}_{i}(k)
\end{align*}
となり，$\delta_i(k)=0$のときは
\begin{align*}
 h^{\inf}_{i}(k)\leq h_i(k) \leq -\epsilon_i(k)\ (<0)
\end{align*}
となるので，$\epsilon_i(k)$の値を十分に小さくすれば，任意の精度で制約条件式を不等式制約式に変換可能であることが確認できる．
また，初期時刻を$k=t$とおくと，式(\ref{eq:d1})から$k>t$の$h_i(k)$について以下の不等式が成り立つ．
\begin{align*}
 h_{i}(k) &= e_i(k) +\sum_{j=1}^{N}u_{j,i}(k) -\alpha_i d_i(k)\\
&\geq -\alpha_i d_i(k)\\
&= -\alpha_i \bigg( d_i(k-1)-s_i(k-1)+p_i(k-1) \bigg)\\
&\geq -\alpha_i \bigg( d_i(k-1)+p_i(k-1) \bigg)\\
&\geq -\alpha_i \bigg( d_i(k-2)+p_i(k-2)+p_i(k-1) \bigg)\\
&\geq \cdots\\
&\geq -\alpha_i \bigg( d_i(t)+\sum_{c=t}^{k-1}p_i(c) \bigg)\\
 h_{i}(k) &\leq e_i(k) +\sum_{j=1}^{N}u_{j,i}(k)\\
&\leq L\\
\end{align*}
したがって，$h_i(k)$の上界と下界を以下のように定める．
\begin{align}
 h_{i}^{\sup}(k) &= L\label{eq:h_sup}\\
 h_{i}^{\inf}(k) &= -\alpha_i \bigg( d_i(t)+\sum_{c=t}^{k-1}p_i(c) \bigg)\label{eq:h_inf}
\end{align}

論理変数$\delta_i(k)$を用いることで式(\ref{eq:s1})は以下のように変形できる．
\begin{align}
s_i(k) &= \delta_i(k)\alpha_id_i(k)+(1-\delta_i(k))(h_i(k)+\alpha_i d_i(k))\nonumber\\
&= -\delta_i(k)h_i(k)+h_i(k)+\alpha_i d_i(k)\label{eq:s1_new}
\end{align}
ここで，
\begin{align}
z_i(k) = \delta_i(k)h_i(k)\label{eq:z1}
\end{align}
とおくと，式(\ref{eq:s1_new})は
\begin{align}
s_i(k) = -z_i(k)+h_i(k)+\alpha_i d_i(k)\label{eq:s1_newnew}
\end{align}
となる．
式(\ref{eq:z1})は次の不等式制約条件になる\cite{bib11}．
\begin{align}
 & h^{\inf}_{i}(k) \delta_i(k) \leq z_i(k) \leq h^{\sup}_{i}(k) \delta_i(k)\label{eq:z1_1}\\
& h_i(k)-h^{\sup}_i(k) (1-\delta_i(k)) \leq z_i(k) \leq h_i(k)-h^{\inf}_i(k) (1-\delta_i(k))\label{eq:z1_2}
\end{align}

\par
以上より，初期時刻を$k=t$とおくと，タクシー移動モデルは以下の混合論理動的システムで記述される．
\begin{align}
 & x_i(k+1) = e_i(k)-s_i(k)+\sum_{j=1}^{N} u_{j,i}(k) \label{eq:x2}\\
 & r(k) = L-\sum_{i=1}^{N}x_i(k) \label{eq:r2}\\
 & e_i(k) = \beta_{i}r(k) \label{eq:e2}\\
 & h^{\inf}_{i}(k)(1-\delta_i(k))\leq h_i(k) \leq h^{\sup}_{i}(k) \delta_i(k)+(\delta_i(k) -1) \epsilon_i(k) \label{eq:delta2}\\
 & s_i(k) = -z_i(k)+h_i(k)+\alpha_i d_i(k)\label{eq:s2}\\
 & h^{\inf}_{i}(k) \delta_i(k) \leq z_i(k) \leq h^{\sup}_{i}(k) \delta_i(k)\label{eq:z2_1}\\
 & h_i(k)-h^{\sup}_i(k) (1-\delta_i(k)) \leq z_i(k) \leq h_i(k)-h^{\inf}_i(k) (1-\delta_i(k))\label{eq:z2_2}\\
 & h_{i}^{\sup}(k) = L\label{eq:h2_sup}\\
 & h_{i}^{\inf}(k) = -\alpha_i \bigg( d_i(t)+\sum_{c=t}^{k-1}p_i(c) \bigg)\label{eq:h2_inf}\\
 & d_i(k+1) = d_i(k)-s_i(k)+p_i(k) \label{eq:d2}\\
 & h_i(k) = e_i(k) +\sum_{j=1}^{N}u_{j,i}(k) -\alpha_i d_i(k) \label{eq:h2}\\
 & x_i(k) = \sum_{j=1}^{N}u_{i,j}(k) \label{eq:input2}\\
 & u_{i, \ell}(k) = 0 \qquad  \mbox{if セル$i$からセル$j$に移動不可能}\label{eq:ell2}
\end{align}
 \section{モデル予測制御}
 \label{sec:3_3}
 \subsection{定式化}
 \label{sec:3_3_1}
 節\ref{sec:3_2}で導出したタクシーモデルをもとに，時刻$t$において以下の有限区間最適制御問題を考える．
ただし，$T$は正の整数である．
  \subsection{実装結果}
  \label{sec:3_3_2}
 \section{結言}
 \label{sec:3_4}
 \par
 あ
%  \par
% 時刻$k$のときの各領域（セル）$i(i=1, 2, \ldots , N)$での空車数を$x_i(k)$とおく．時間区間$[k,\ k+1)$の間に，領域$i$で実車になるタクシー数を$s_i(k)$，空車になるタクシー数を$e_i(k)$とおく．入力として，時間区間$[k,\ k+1)$に間に領域$i$から$j$へ移動する空車数$u_{i,j}(k)$とおく．ここで，$u_{i,i}(k)$は領域$i$にとどまる空車数である．すると各領域の空車数のダイナミクスは，
% \begin{equation}  \label{eqn:system}
% x_i(k+1)=x_i(k)-s_i(k)+e_i(k)+\sum_{j=1}^{N}\bigg (u_{j,i}(k)-u_{i,j}(k) \bigg)
% \end{equation}
% となる．

% $d_i(k)$を時刻$k$のときの領域$i$で発生する需要とおく．
% \begin{equation} \label{eqn:d}
% d_i(k+1)=d_i(k)-s_i(k)+p_i(k)
% \end{equation}
% である．ただし，$p_i(k)$は時間区間$[k,\ k+1)$の間で新たに発生する需要であり，実データから予想される．制御理論的に言えば，外乱のようなもの．
% 時間区間$[k,k+1)$に間に空車になるタクシー数$e_i(k)$は
% \begin{equation} \label{eqn:e_i}
% e_i(k)=\beta_{i}r(k)
% \end{equation}
% ただし，$r(k)$は時刻$k$のときの実車の総数で，$\beta_{i}$は領域$i$で実車全体の中で領域$i$で空車になる割合である．つまり，時刻$k$のときの実車の中から$\beta_{i}r(k)$だけが時間区間$[k,\ k+1)$の間で領域$i$で空車になることを表し，$\beta_i$は実データから推定される．
% 実車の総数$r(k)$は，式(\ref{eqn:e_i})を用いると
% \begin{eqnarray}
% r(k+1) &=& r(k)+\sum_{i=1}^{N}\bigg( s_i(k)-e_i(k)\bigg) \nonumber \\
% 	&=& r(k)+\sum_{i=1}^{N}\bigg( s_i(k)-\beta_i r(k)\bigg) \nonumber  \\
% 	&=& \bigg( 1-\sum_{i=1}^{N}\beta_i\bigg) r(k)+\sum_{i=1}^{N} s_i(k) \label{eqn:r}
% \end{eqnarray}
% である．ここで，入力に関する制約として，各領域$i$について
% \begin{equation} \label{eqn:con}
% x_i(k)=\sum_{j=1}^{N}u_{i,j}(k)
% \end{equation}
% を与える．このことは，各領域において時刻$k$での空車をどこに移動させるかを決定し，それに沿って，空車が移動すると仮定していることになる．空車は制御入力に従って移動してから乗車できると仮定する．

% このように入力（移動する空車数））を与えると，式(\ref{eqn:system}), (\ref{eqn:e_i}), (\ref{eqn:con})からシステムダイナミクスは
% \begin{equation}  \label{eqn:simple_system}
% x_i(k+1)=\beta_i r(k)-s_i(k)+\sum_{j=1}^{N} u_{j,i}(k)
% \end{equation}
% となる．ここで，式(\ref{eqn:r}), (\ref{eqn:con}), (\ref{eqn:simple_system})から
% \begin{eqnarray*}
% r(k+1)+\sum_{i=1}^{N}x_i(k+1) &=&  \bigg( 1-\sum_{i=1}^{N}\beta_i\bigg) r(k)+\sum_{i=1}^{N} s_i(k) + \sum_{i=1}^{N}\bigg( \beta_i r(k)-s_i(k)+\sum_{j=1}^{N} u_{j,i}(k) \bigg)\\
% &=& r(k)+\sum_{i=1}^{N}x_i(k)
% \end{eqnarray*}
% この式は，タクシーの総数が時間で変動しないことを意味する．もともとタクシーの総数が変化するような制御をかけていないので，この結果は妥当といえる．
% そこで，タクシーの総数を$L$とおくと
% \begin{equation}
% r(k)= L-\sum_{i=1}^{N}x_i(k)
% \end{equation}
% とおける．したがって，式(\ref{eqn:simple_system})は
% \begin{equation}  \label{eqn:simple_system2}
% x_i(k+1)=\beta_i \bigg(L-\sum_{j=1}^{N} x_j(k) \bigg) -s_i(k)+\sum_{j=1}^{N} u_{j,i}(k)
% \end{equation}
% さらに自動車の移動から必ず$0$にしなければならない$u_{i,j}(k)$
% があるはずです．例えば，領域$i$に隣接しない領域$\ell$については
% \begin{equation} \label{eqn:u_seiyaku}
% u_{i, \ell}(k)=0 \qquad  \forall k
% \end{equation}
% とおいてもよい．このような入力は，式(\ref{eqn:simple_system})からはずしておいてよいでしょう．

% 以上より，タクシーの総数$L$を用いて，制約条件は以下のようになる．
% \begin{eqnarray}
% x_i(k+1) &=& \beta_i \bigg(L-\sum_{j=1}^{N} x_j(k) \bigg) -s_i(k)+\sum_{j=1}^{N} u_{j,i}(k) \\
% d_i(k+1) &=& d_i(k)-s_i(k)+p_i(k)
% \end{eqnarray}
% ここで，時間区間$[k,\ k+1)$の間で実車になる台数$s_i(k)$については以下のように考える．まず，時刻$k$での空車が制御入力に従って，移動してから実車になりうるとする．このとき，時間区間$[k,\ k+1)$の間で実車から空車になるタクシーもすぐに実車になりうるので，時間区間$[k,\ k+1)$の間に領域$i$にいる実車になりうるタクシーの台数は$\beta_i r(k)+\sum_{j=1}^{N}u_{j,i}(k)$であり，実車になる台数はこの数を超えることはないので，
% \begin{equation} \label{eqn:s2}
% s_i(k)=\left\{
% \begin{array}{ll}
%  \alpha_i d_i(k) & \mbox{if }\beta_i \bigg( L-\sum_{j=1}^{N}x_j(k)\bigg) +\sum_{j=1}^{N}u_{j,i}(k) -\alpha_i d_i(k) \geq 0 \\
% \beta_i \bigg( L-\sum_{j=1}^{N}x_j(k)\bigg) +\sum_{j=1}^{N}u_{j,i}(k) & \mbox{otherwise}
% \end{array}\right.
% \end{equation}
% ただし，$\alpha_i$は領域$i$においてタクシーに乗車できる乗客の割合（定数・同定する必要あり．）である．
% ここで，式(\ref{eqn:s2})が条件付きの式になっている．この式は以下のように変形すれは，システム全体はMLD（Mixed Logical Dynamical）システムになる．なお，MLDシステムの性質については松本さんの卒論を見てください．

% まず，以下の論理変数$\delta_i(k) \in \{ 0,\ 1\}$を導入する．
% \begin{equation} \label{eqn:delta}
% \delta_i(k)=
% \left\{ \begin{array}{ll}
% 1 & \mbox{if }h_i(x_1(k),\ \ldots, x_N(k),\ u_{1,i}(k),\ldots, u_{N,i}(k),d_i(k))\geq 0 \\
% 0 & \mbox{otherwise}
% \end{array} \right.
% \end{equation}
% と定義する．ただし，
% \begin{equation} \label{eqn:h}
% h_i(x_1,\  \ldots, x_N,\ u_{1,i},\ldots, u_{N,i},\ d_i)=\beta_i \bigg( L-\sum_{j=1}^{N}x_j\bigg) +\sum_{j=1}^{N}u_{j,i}(k) -\alpha_i d_i
% \end{equation}
% である．このとき，松本さんの卒論の補題2.3(i)から，制約条件式(\ref{eqn:delta})は次の不等式制約条件になる．
% \begin{eqnarray} \label{ineq:delta}
% h^{inf}_{i}(1-\delta_i(k))\leq h_i(k) \leq h^{sup}_{i} \delta_i(k)+(\delta_i(k) -1) \epsilon
% \end{eqnarray}
% ただし$h_i(k)=h_i(x_1(k),\  \ldots, x_N(k),\ u_{1,i}(k),\ldots, u_{N,i}(k),\ d_i(k))$と略記し，$h^{inf}_{i}$, $h^{sup}_{i} \in R$は取りうる任意の$(x_1,\  \ldots, x_N,\ u_{1,i},\ldots, u_{N,i},\ d_i)$に対して$h^{inf}_{i}\leq h_i(x_1,\  \ldots, x_N,\ u_{1,i},\ldots, u_{N,i},\ d_i)\leq h^{sup}_{i}$であり，$\epsilon \in R_{+}$は十分に小さな正の実数である（この数は$i$に独立でよいでしょう．，$h^{inf}_{i}$, $h^{sup}_{i}$も$i$に独立に指定してもよいかもしれません．）．

% 式(\ref{eqn:s2})は以下のように変形できる．
% \begin{eqnarray}
% s_i(k) &=& \delta_i(k) \alpha_i d_i(k)+(1-\delta_i(k))S_i(k) \\
% 	&=& -\delta_i(k)h_i(k)+S_i(k)
% \end{eqnarray}
% ただし，
% \[
% S_i(k)=\beta_i \bigg( L-\sum_{j=1}^{N}x_j(k)\bigg) +\sum_{j=1}^{N}u_{j,i}(k)
% \]
% である．
% ここで，
% \begin{equation} \label{eqn:z}
% z_i(k)=-\delta_i (k) h_i(k) \qquad \bigg( =\delta_i(k) ( -h_i(k)) \bigg)
% \end{equation}
% とおくと，
% \begin{equation} \label{eqn:s_z_x}
% s_i(k)=z_i(k)+S_i(k)
% \end{equation}
% となる，ここで，松本さんの卒論の補題2.3(ii)から，式(\ref{eqn:z})は，
% \begin{eqnarray}
% & -h^{sup}_{i} \delta_i(k) \leq z_i(k) \leq -h^{inf}_{i} \delta_i(k) & \label{ineq:z1}\\
% & -h_i(k)+h^{inf}_i (1-\delta_i(k)) \leq z_i(k) 
%    \leq -h_i(k)+h^{sup}_i (1-\delta_i(k)) & \label{ineq:z2}
% \end{eqnarray}
% と変換できる．

% これらの式は線形なので，求める最適化問題は混合整数計画問題（制約条件式が線形の等式または不等式で書かれている．）として定式化できる．
 \include{end}